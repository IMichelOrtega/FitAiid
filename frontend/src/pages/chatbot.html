<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fitty - Tu Coach Fitness | FitAiid</title>
    <link rel="stylesheet" href="../styles/chatbot.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  </head>
  <body>
    <div class="chat-container">
      <!-- Sidebar / Info Panel (visible en desktop) -->
      <aside class="chat-sidebar">
        <div class="sidebar-header">
          <img src="../img/logo.png" alt="FitAiid Logo" class="sidebar-logo" />
          <h2>Fit<span>Aiid</span></h2>
        </div>
        
        <div class="coach-profile">
          <div class="coach-avatar">
            <img src="../img/image-removebg-preview (23).png" alt="Fitty" />
            <span class="status-dot"></span>
          </div>
          <h3>Fitty</h3>
          <p>Tu Coach Personal con IA</p>
        </div>

        <div class="coach-capabilities">
          <h4><i class="fas fa-magic"></i> Puedo ayudarte con:</h4>
          <ul>
            <li><i class="fas fa-dumbbell"></i> Rutinas personalizadas</li>
            <li><i class="fas fa-apple-alt"></i> Consejos de nutrici√≥n</li>
            <li><i class="fas fa-heartbeat"></i> T√©cnicas de ejercicios</li>
            <li><i class="fas fa-fire"></i> Motivaci√≥n diaria</li>
            <li><i class="fas fa-question-circle"></i> Resolver tus dudas</li>
          </ul>
        </div>

        <a href="home.html" class="back-home-btn">
          <i class="fas fa-arrow-left"></i> Volver al inicio
        </a>
      </aside>

      <!-- Main Chat Area -->
      <main class="chat-main">
        <!-- Chat Header -->
        <header class="chat-header">
          <a href="home.html" class="back-btn-mobile">
            <i class="fas fa-arrow-left"></i>
          </a>
          
          <div class="header-info">
            <div class="header-avatar">
              <img src="../img/image-removebg-preview (23).png" alt="Fitty" />
              <span class="status-indicator"></span>
            </div>
            <div class="header-text">
              <h1>Fitty</h1>
              <span class="status-text"><i class="fas fa-circle"></i> En l√≠nea</span>
            </div>
          </div>

          <button class="menu-btn" id="menuBtn">
            <i class="fas fa-ellipsis-v"></i>
          </button>
        </header>

        <!-- Messages Container -->
        <div id="chat-box" class="chat-box">
          <!-- Fecha del chat -->
          <div class="date-divider">
            <span>Hoy</span>
          </div>

          <!-- Mensaje de bienvenida -->
          <div class="message ai">
            <div class="message-avatar">
              <img src="../img/image-removebg-preview (23).png" alt="Fitty" />
            </div>
            <div class="message-content">
              <div class="message-bubble">
                <p>¬°Hola! üëã Soy <strong>Fitty</strong>, tu coach personal fitness.</p>
                <p>Estoy aqu√≠ para ayudarte a alcanzar tus metas. ¬øEn qu√© puedo asistirte hoy? üí™</p>
              </div>
              <span class="message-time">Ahora</span>
            </div>
          </div>
        </div>

        <!-- Quick Suggestions -->
        <div class="quick-suggestions" id="suggestions">
          <span class="suggestion-label">Sugerencias:</span>
          <div class="suggestions-scroll">
            <button class="suggestion-btn" data-msg="Dame una rutina para hoy">
              <i class="fas fa-dumbbell"></i> Rutina del d√≠a
            </button>
            <button class="suggestion-btn" data-msg="¬øQu√© debo comer antes de entrenar?">
              <i class="fas fa-utensils"></i> Pre-entreno
            </button>
            <button class="suggestion-btn" data-msg="Necesito motivaci√≥n">
              <i class="fas fa-fire"></i> Motivaci√≥n
            </button>
            <button class="suggestion-btn" data-msg="¬øC√≥mo hago una sentadilla correcta?">
              <i class="fas fa-running"></i> T√©cnica
            </button>
          </div>
        </div>

        <!-- Input Area -->
        <div class="chat-input-container">
          <div class="chat-input">
            <input 
              type="text" 
              id="user-input" 
              placeholder="Escribe tu mensaje..." 
              autocomplete="off"
            />
            <button id="send-btn" class="send-btn" title="Enviar mensaje">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
          <p class="input-hint">
            <i class="fas fa-shield-alt"></i> Fitty est√° dise√±ado para darte consejos fitness generales
          </p>
        </div>
      </main>
    </div>

    <!-- PROTECCI√ìN DE AUTENTICACI√ìN -->
    <script src="../scripts/auth-guard.js"></script>
    
    <script>
      const chatBox = document.getElementById("chat-box");
      const userInput = document.getElementById("user-input");
      const sendBtn = document.getElementById("send-btn");
      const suggestions = document.getElementById("suggestions");

      // Verificar autenticaci√≥n
      if (!userId) {
        addMessage("‚ö†Ô∏è Por favor inicia sesi√≥n para usar el chat.", "ai");
        userInput.disabled = true;
        sendBtn.disabled = true;
      }

      // Event Listeners
      sendBtn.addEventListener("click", sendMessage);
      userInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
      });

      // Sugerencias r√°pidas
      document.querySelectorAll(".suggestion-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const msg = btn.getAttribute("data-msg");
          userInput.value = msg;
          sendMessage();
        });
      });

      // Ocultar sugerencias cuando hay mensajes
      userInput.addEventListener("input", () => {
        if (userInput.value.length > 0) {
          suggestions.classList.add("hidden");
        } else {
          suggestions.classList.remove("hidden");
        }
      });

      async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        // Ocultar sugerencias despu√©s del primer mensaje
        suggestions.style.display = "none";

        addMessage(text, "user");
        userInput.value = "";

        // Mostrar indicador de escritura
        const typingIndicator = createTypingIndicator();
        chatBox.appendChild(typingIndicator);
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
          const res = await fetch("http://localhost:5000/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
              message: text,
              user_id: userId
            }),
          });
          
          const data = await res.json();
          chatBox.removeChild(typingIndicator);

          if (data.reply) {
            addMessage(data.reply, "ai");
          } else if (data.error) {
            addMessage(`‚ö†Ô∏è ${data.error}`, "ai");
          } else {
            addMessage("‚ö†Ô∏è No recib√≠ una respuesta v√°lida.", "ai");
          }

        } catch (error) {
          console.error("Error:", error);
          chatBox.removeChild(typingIndicator);
          addMessage("‚ùå No pude conectarme con Fitty. Verifica tu conexi√≥n.", "ai");
        }
      }

      function createTypingIndicator() {
        const div = document.createElement("div");
        div.classList.add("message", "ai", "typing-indicator");
        div.innerHTML = `
          <div class="message-avatar">
            <img src="https://cdn-icons-png.flaticon.com/512/4712/4712103.png" alt="Fitty" />
          </div>
          <div class="message-content">
            <div class="message-bubble typing">
              <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          </div>
        `;
        return div;
      }

      function addMessage(text, sender) {
        const div = document.createElement("div");
        div.classList.add("message", sender);
        
        const time = new Date().toLocaleTimeString('es-ES', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });

        if (sender === "ai") {
          const formattedText = formatMessage(text);
          div.innerHTML = `
            <div class="message-avatar">
              <img src="https://cdn-icons-png.flaticon.com/512/6134/6134346.png" alt="Fitty" />
            </div>
            <div class="message-content">
              <div class="message-bubble">
                ${formattedText}
              </div>
              <span class="message-time">${time}</span>
            </div>
          `;
        } else {
          div.innerHTML = `
            <div class="message-content">
              <div class="message-bubble">
                <p>${text}</p>
              </div>
              <span class="message-time">${time}</span>
            </div>
          `;
        }
        
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function formatMessage(text) {
        // Convertir saltos de l√≠nea a <br>
        let formatted = text.replace(/\n/g, '<br>');
        
        // Convertir **texto** a <strong>texto</strong>
        formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // Convertir listas con - a elementos de lista
        if (formatted.includes('<br>- ')) {
          const parts = formatted.split('<br>- ');
          if (parts.length > 1) {
            formatted = parts[0] + '<ul class="chat-list">' + 
              parts.slice(1).map(item => `<li>${item}</li>`).join('') + 
              '</ul>';
          }
        }

        return `<p>${formatted}</p>`;
      }

      // Mensaje inicial personalizado
      window.addEventListener('load', async () => {
        if (!userId) return;

        try {
          const res = await fetch(`http://localhost:5000/api/questionnaire/${userId}`);
          
          if (res.ok) {
            const data = await res.json();

            if (data.success && data.data && data.data.hasCompletedQuestionnaire) {
              const profile = data.data.fitnessProfile;
              setTimeout(() => {
                addMessage(
                  `He revisado tu perfil üìã\n\nTu objetivo: **${profile.mainGoal}**\nD√≠as de entreno: **${profile.trainingDaysPerWeek} por semana**\n\n¬°Preg√∫ntame lo que necesites para alcanzar tu meta! üéØ`,
                  "ai"
                );
              }, 1500);
            }
          }
        } catch (error) {
          console.log("No se pudo cargar el perfil");
        }
      });
    </script>
  </body>
</html>